<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SOP Simulator ‚Äî Trainee</title>
<style>
  :root{--bg:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--accent:#059669;--accent2:#047857;--warn:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .top{height:52px;display:flex;align-items:center;gap:12px;padding:0 12px;background:#fff;border-bottom:1px solid var(--line)}
  .brand{display:flex;gap:8px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:var(--accent);color:#fff;display:grid;place-items:center;font-weight:800}
  .layout{display:grid;gap:16px;grid-template-columns:220px 1fr 320px;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px}
  .rail{padding:12px;display:flex;flex-direction:column}
  .nav-label{font-size:12px;color:var(--muted);font-weight:600;margin:8px 0 6px}
  .nav-item{padding:8px;border-radius:12px;display:flex;gap:8px;align-items:center}
  .nav-item.active{background:#eef2f7;font-weight:600}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
  .btn:hover{background:#f8fafc}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent2)}
  .btn.danger{color:var(--warn);border-color:#fecaca}
  .btn.danger:hover{background:#fef2f2}
  .filters{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
  .select,.input{border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:13px;background:#fff}
  .row{display:flex;gap:12px;padding:12px;border-bottom:1px solid var(--line);cursor:pointer}
  .row:hover{background:#f8fafc}
  .avatar{width:36px;height:36px;border-radius:999px;background:#e5e7eb;display:grid;place-items:center;flex-shrink:0}
  .pill{background:#eef2f7;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:11px}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .head{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
  .grid{display:grid;gap:16px;grid-template-columns:300px 1fr 320px;padding:12px}
  .bubble{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px}
  textarea{width:100%;min-height:120px;border:1px solid var(--line);border-radius:12px;padding:10px;font:inherit}
  .badge{font-size:11px;border:1px solid #bbf7d0;background:#ecfdf5;color:#065f46;padding:2px 8px;border-radius:999px}
  .kpi{display:flex;justify-content:space-between;align-items:center}
  .right{padding:12px}.pad{padding:12px}
  .hidden{display:none}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);padding:6px;text-align:left;font-size:12px}
  .ok{color:#065f46}.fail{color:#991b1b}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
  dialog::backdrop{background:rgba(0,0,0,.25)}
  dialog{border:1px solid var(--line);border-radius:16px;padding:0;max-width:720px;width:calc(100% - 24px)}
</style>
</head>
<body>
  <div class="top">
    <div class="brand"><div class="logo">Z</div><div class="small muted">SOP Simulator (Trainee)</div></div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <!-- Only Reset remains -->
      <button class="btn" id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT RAIL -->
    <aside class="rail card">
      <div class="nav-label">Your work</div>
      <div class="nav-item active"><span>üìÑ</span><span>Tickets</span></div>
      <div class="nav-label">Completed</div>
      <div class="nav-item"><span>üóìÔ∏è</span><span>Last 30 days</span></div>
    </aside>

    <!-- CENTER -->
    <main class="card">
      <div class="filters">
        <strong id="countLbl">0 tickets</strong>
        <label class="small muted">Submit As
          <select class="select" id="fStatus">
            <option>All</option><option>Open</option><option>Pending</option><option>Solved</option>
          </select>
        </label>
        <label class="small muted">Channel
          <select class="select" id="fChannel">
            <option>All</option><option>Email</option><option>Web</option><option>Chat</option>
          </select>
        </label>
        <input id="searchBox" class="input" placeholder="Search subject or text"/>
      </div>

      <div id="list"></div>

      <div id="detail" class="hidden">
        <div class="head">
          <button class="btn" id="backBtn">‚Üê Back</button>
          <div id="dSubject" style="font-weight:600"></div>
          <div style="margin-left:auto"></div>
          <label class="small muted">Submit As
            <select class="select" id="dStatus"><option>Open</option><option>Pending</option><option>Solved</option></select>
          </label>
          <label class="small muted">Assignee
            <select class="select" id="dAssignee"><option>Myself</option><option>Support Tier 2</option><option>Support Tier 3</option><option>Fraud General</option><option>Payout</option></select>
          </label>
        </div>
        <div class="grid">
          <aside>
            <div class="small muted">Requester</div><div id="dRequester" class="small">‚Äî</div>
            <div class="small muted" style="margin-top:6px">Created</div><div id="dCreated" class="small">‚Äî</div>
            <!-- Trainer preview hidden for trainees -->
            <div class="small muted" style="margin-top:6px;display:none">Expected (Trainer)</div>
            <div id="dExpected" class="bubble small mono" style="display:none">‚Äî</div>
          </aside>

          <section>
            <div id="thread"></div>
            <div style="border-top:1px solid var(--line);padding-top:8px">
              <textarea id="replyBox" placeholder="Write your reply‚Ä¶ (trainee)"></textarea>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
                <button class="btn primary" id="submitBtn">Submit As</button>
              </div>
            </div>
          </section>

          <aside class="pad card">
            <div class="small" style="font-weight:600">Auto-Grade</div>
            <table class="table" id="gradeTable">
              <thead><tr><th>Check</th><th>Result</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="small" style="margin-top:8px">Score: <strong id="scoreLbl">0/100</strong></div>
            <div class="small" style="margin-top:4px">Pass threshold: <strong id="passLbl"></strong></div>
          </aside>
        </div>
      </div>
    </main>

    <!-- RIGHT RAIL -->
    <aside class="rail right card">
      <div class="pad">
        <div style="font-weight:600">Ticket statistics</div>
        <div class="kpi"><span class="muted small">Solved (7d)</span><span id="kSolved">0</span></div>
        <div class="kpi"><span class="muted small">Open now</span><span id="kOpen">0</span></div>
      </div>
      <div class="pad">
        <div style="font-weight:600">QA average grade</div>
        <div class="muted small">(auto-graded)</div>
        <div style="font-size:24px;font-weight:800" id="kAvg">‚Äî</div>
      </div>
    </aside>
  </div>

<!-- DEFAULT tickets & constants (must be before app code) -->
<script>
  function uid(){ return Math.random().toString(36).slice(2,9); }

  const STORE = "sop_sim_state_v10";
  const now   = Date.now();

  const ALLOWED_ASSIGNEES = ["Myself","Support Tier 2","Support Tier 3","Fraud General","Payout"];

  const DEFAULT = {
    weights: { keywords: 40, sections: 20, status: 25, assignee: 15, pass: 80 },
    tickets: [
      {
        id: uid(),
        subject: "Can't log in after password reset",
        requester: "sara@brand.co",
        channel: "Email",
        createdAt: now - 4 * 3600e3,
        status: "Open",
        assignee: "Myself",
        assigneeOptions: ALLOWED_ASSIGNEES,
        messages: [
          { id: uid(), author: "sara@brand.co", ts: now - 4 * 3600e3,
            body: "Hi, I reset my password but still can‚Äôt log in. The reset email worked. Browser: Chrome on Windows. ‚Äî Sara" }
        ],
        expected: {
          requiredStatus: "Pending",
          requiredAssignee: "Myself",
          keywords: [],
          sections: ["Greeting","Diagnosis","Resolution","Next steps","Sign-off"]
        },
        attempts: [],
        grade: null
      },
      {
        id: uid(),
        subject: "Refund for duplicate charge",
        requester: "customer@example.com",
        channel: "Email",
        createdAt: now - 30 * 3600e3,
        status: "Open",
        assignee: "Myself",
        assigneeOptions: ALLOWED_ASSIGNEES,
        messages: [
          { id: uid(), author: "customer@example.com", ts: now - 30 * 3600e3,
            body: "I was double-charged this month. Can you refund the duplicate? Thanks!" }
        ],
        expected: {
          requiredStatus: "Pending",
          requiredAssignee: "Payout",
          keywords: [],
          sections: ["Greeting","Resolution","Next steps","Sign-off"]
        },
        attempts: [],
        grade: null
      }
    ]
  };

  // seed or load state
  let state = null;
  try { state = JSON.parse(localStorage.getItem(STORE) || "null"); } catch {}
  if (!state || !Array.isArray(state.tickets)) {
    state = structuredClone(DEFAULT);
    localStorage.setItem(STORE, JSON.stringify(state));
  }
</script>

<!-- Main app script -->
<script>
(() => {
  // --- helpers / storage ---
  function save(){ localStorage.setItem(STORE, JSON.stringify(state)); }
  function fmt(d){ return d.toLocaleString(); }
  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  // --- elements ---
  const list = document.getElementById("list");
  const detail = document.getElementById("detail");
  const countLbl = document.getElementById("countLbl");
  const fStatus = document.getElementById("fStatus");
  const fChannel = document.getElementById("fChannel");
  const searchBox = document.getElementById("searchBox");

  const backBtn = document.getElementById("backBtn");
  const dSubject = document.getElementById("dSubject");
  const dRequester = document.getElementById("dRequester");
  const dCreated = document.getElementById("dCreated");
  const dExpected = document.getElementById("dExpected");
  const dStatus = document.getElementById("dStatus");
  const dAssignee = document.getElementById("dAssignee");
  const thread = document.getElementById("thread");
  const replyBox = document.getElementById("replyBox");
  const submitBtn = document.getElementById("submitBtn");

  const gradeTable = document.querySelector("#gradeTable tbody");
  const scoreLbl = document.getElementById("scoreLbl");
  const passLbl  = document.getElementById("passLbl");

  const kSolved = document.getElementById("kSolved");
  const kOpen = document.getElementById("kOpen");
  const kAvg = document.getElementById("kAvg");
  const resetBtn = document.getElementById("resetBtn");

  let currentId = null;

  // --- stats (define before renderAll) ---
  function renderStats(){
    const weekAgo = Date.now() - 7*24*3600e3;
    const solved = state.tickets.filter(t=>t.status==="Solved" && t.createdAt>=weekAgo).length;
    const open = state.tickets.filter(t=>t.status!=="Solved").length;
    kSolved.textContent = solved;
    kOpen.textContent = open;
    const graded = state.tickets.map(t=>t.grade?.score).filter(x=>typeof x==="number");
    kAvg.textContent = graded.length? (graded.reduce((a,b)=>a+b,0)/graded.length).toFixed(0): "‚Äî";
  }

  // --- filters / list ---
  function filtered(){
    const q=(searchBox.value||"").toLowerCase();
    return state.tickets.filter(t=>{
      const okS = fStatus.value==="All"||t.status===fStatus.value;
      const okC = fChannel.value==="All"||t.channel===fChannel.value;
      const text = (t.subject+" "+t.requester+" "+t.messages.map(m=>m.body).join(" ")+" "+(t.expected?.sections||[]).join(" ")).toLowerCase();
      const okQ = !q || text.includes(q);
      return okS && okC && okQ;
    });
  }

  function renderList(){
    const items = filtered();
    countLbl.textContent = `${items.length} tickets`;
    list.innerHTML = items.map(t=>`
      <div class="row" data-id="${t.id}">
        <div class="avatar">üì®</div>
        <div style="flex:1;min-width:0">
          <div class="small" style="display:flex;align-items:center;gap:8px">
            <span style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.subject)}</span>
            <span class="pill">${esc(t.channel)}</span>
            ${t.grade?`<span class="badge">${t.grade.score.toFixed(0)}/100</span>`:""}
          </div>
          <div class="small muted">${esc(t.requester)} ‚Ä¢ ${fmt(new Date(t.createdAt))}</div>
        </div>
        <div class="small muted" style="width:120px;text-align:right">${esc(t.status)}</div>
      </div>
    `).join("");

    [...list.querySelectorAll(".row")].forEach(el=>el.onclick=()=>openDetail(el.dataset.id));

    if(items.length===0){
      list.innerHTML = `<div style="padding:48px;text-align:center;color:var(--muted)">
        <div style="font-size:48px;margin-bottom:8px">üë®‚Äç‚úàÔ∏è</div>
        <div style="font-weight:700">No tickets</div>
        <div class="small">Work you're assigned will appear here.</div></div>`;
    }
  }

  function renderAssigneeOptions(t){
    const opts=(t.assigneeOptions&&t.assigneeOptions.length)?t.assigneeOptions:ALLOWED_ASSIGNEES;
    dAssignee.innerHTML = opts.map(o=>`<option>${esc(o)}</option>`).join("");
  }

  function openDetail(id){
    currentId=id;
    const t=state.tickets.find(x=>x.id===id); if(!t) return;
    document.getElementById("list").classList.add("hidden");
    detail.classList.remove("hidden");
    dSubject.textContent = t.subject;
    dRequester.textContent = t.requester||"‚Äî";
    dCreated.textContent = fmt(new Date(t.createdAt));
    dStatus.value = ["Open","Pending","Solved"].includes(t.status) ? t.status : "Open";
    renderAssigneeOptions(t);
    dAssignee.value = t.assignee || ALLOWED_ASSIGNEES[0];

    // trainer preview hidden, but keep content for code debugging
    dExpected.textContent = `Required Submit As: ${t.expected.requiredStatus}
Required Assignee: ${t.expected.requiredAssignee}
Keywords: ${(t.expected.keywords||[]).join(", ") || "‚Äî"}
Sections: ${(t.expected.sections||[]).join(" > ") || "‚Äî"}`;

    replyBox.value = "";
    thread.innerHTML = "";
    t.messages.forEach(m=>{
      const d=document.createElement("div"); d.className="bubble";
      d.innerHTML = `<div class="small muted" style="margin-bottom:4px">${esc(m.author)} ‚Ä¢ ${fmt(new Date(m.ts))}</div>
        <div class="small" style="white-space:pre-wrap">${esc(m.body)}</div>`;
      thread.appendChild(d);
    });
    renderGrade(t.grade || null);
  }

  function showList(){ detail.classList.add("hidden"); document.getElementById("list").classList.remove("hidden"); renderList(); }

  function renderGrade(report){
    gradeTable.innerHTML = ""; scoreLbl.textContent = "0/100"; passLbl.textContent = state.weights.pass + "/100";
    if(!report){ return; }
    for(const c of report.checks){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="small">${esc(c.label)}<div class="muted small">${esc(c.detail||"")}</div></td>
                      <td class="small ${c.ok?"ok":"fail"}">${c.ok?"‚úÖ Pass":"‚ùå Fail"}</td>`;
      gradeTable.appendChild(tr);
    }
    scoreLbl.textContent = `${report.score.toFixed(0)}/100 ${report.pass?"‚Ä¢ ‚úÖ Pass":"‚Ä¢ ‚ùå Fail"}`;
  }

  function renderAll(){ renderList(); renderStats(); passLbl.textContent = state.weights.pass + "/100"; }

  // --- events ---
  fStatus.onchange = renderList;
  fChannel.onchange = renderList;
  searchBox.oninput = renderList;
  backBtn.onclick = showList;

  // Submit & grade
  submitBtn.onclick = async () => {
    const t = state.tickets.find(x=>x.id===currentId);
    if (!t) return;

    if (typeof window.gradeAttempt !== "function") {
      alert('Grader is not loaded.');
      return;
    }
    if (!t.expected || !("requiredStatus" in t.expected) || !("requiredAssignee" in t.expected)) {
      alert("This ticket is missing grading rules.");
      return;
    }

    const chosenStatus = dStatus.value;
    const chosenAssignee = dAssignee.value;
    const text = (replyBox.value || "").trim();
    if (!text) { alert("Please write a reply before submitting."); return; }

    try {
      const msg = { id: uid(), author: "Trainee", ts: Date.now(), body: text };
      t.messages.push(msg);
      t.status = chosenStatus;
      t.assignee = chosenAssignee;

      const attempt = { ts: msg.ts, reply: text, status: chosenStatus, assignee: chosenAssignee };
      t.attempts.push(attempt);

      const report = await window.gradeAttempt(t, attempt, state.weights);
      if (!report || typeof report.score !== "number") throw new Error("Invalid grade report");
      t.grade = report;

      save();
      renderGrade(report);
      renderStats();
      renderList();
      openDetail(t.id);
      replyBox.value = "";
    } catch (err) {
      console.error("Submit/grade failed:", err);
      alert("Grading failed. Check the browser console for details.");
    }
  };

  // Reset (code-protected)
  const STUDENT_RESET_CODE = "apexreset01";
  resetBtn.onclick = async () => {
    const code = prompt("Enter reset code (provided by your trainer):");
    if (code === null) return;
    if (code.trim() !== STUDENT_RESET_CODE) { alert("Invalid code."); return; }
    state = structuredClone(DEFAULT);
    save();
    renderAll();
    showList();
    alert("Reset complete.");
  };

  // boot
  renderAll();
  showList();
})();
</script>

<!-- Grader (unchanged) -->
<script>
(() => {
  window.gradeAttempt = async function gradeAttempt(ticket, attempt, weights) {
    const w = Object.assign({ sections: 60, status: 25, assignee: 15, pass: 80 }, weights || {});
    const reply = String(attempt.reply || "");

    let ai;
    try {
      const resp = await fetch("/api/grade", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          reply,
          expectedStatus: ticket.expected?.requiredStatus,
          expectedAssignee: ticket.expected?.requiredAssignee
        })
      });
      ai = await resp.json();
      if (!ai || !Array.isArray(ai.checks)) throw new Error("Bad AI JSON");
    } catch (err) {
      console.error("AI grading failed, falling back:", err);
      const statusOk = String(attempt.status) === String(ticket.expected?.requiredStatus);
      const assigneeOk = String(attempt.assignee) === String(ticket.expected?.requiredAssignee);
      const sum = Math.max(1, (w.sections||0) + (w.status||0) + (w.assignee||0));
      const sStructure = 0;
      const sStatus    = (statusOk ? 100 : 0) * (w.status||0) / sum;
      const sAssignee  = (assigneeOk ? 100 : 0) * (w.assignee||0) / sum;
      const score = sStructure + sStatus + sAssignee;

      return {
        checks: [
          { label: "AI grading unavailable", ok: false, detail: "Fallback scoring used" },
          { label: `Submit As is "${ticket.expected?.requiredStatus}"`, ok: statusOk, detail: `Selected: ${attempt.status}` },
          { label: `Assignee is "${ticket.expected?.requiredAssignee}"`, ok: assigneeOk, detail: `Selected: ${attempt.assignee}` }
        ],
        score,
        pass: score >= (w.pass || 0)
      };
    }

    const [greet, ack, sol, offer, close, cStatus, cAssignee] = ai.checks;
    const statusOk   = !!(cStatus && cStatus.ok);
    const assigneeOk = !!(cAssignee && cAssignee.ok);
    const structurePct = Math.max(0, Math.min(100, Number(ai.structurePct || 0)));

    const sum = Math.max(1, (w.sections||0) + (w.status||0) + (w.assignee||0));
    const sStructure = structurePct * (w.sections||0) / sum;
    const sStatus    = (statusOk ? 100 : 0) * (w.status||0) / sum;
    const sAssignee  = (assigneeOk ? 100 : 0) * (w.assignee||0) / sum;
    const score = sStructure + sStatus + sAssignee;

    return {
      checks: [
        { label: "1) Greeting",      ok: !!greet?.ok,  detail: greet?.detail || "" },
        { label: "2) Acknowledge",   ok: !!ack?.ok,    detail: ack?.detail || "" },
        { label: "3) Solution",      ok: !!sol?.ok,    detail: sol?.detail || "" },
        { label: "4) Offer Support", ok: !!offer?.ok,  detail: offer?.detail || "" },
        { label: "5) Closing",       ok: !!close?.ok,  detail: close?.detail || "" },
        { label: `Submit As is "${ticket.expected?.requiredStatus}"`, ok: statusOk,   detail: `Selected: ${attempt.status}` },
        { label: `Assignee is "${ticket.expected?.requiredAssignee}"`, ok: assigneeOk, detail: `Selected: ${attempt.assignee}` }
      ],
      score,
      pass: score >= (w.pass || 0)
    };
  };
})();
</script>
</body>
</html>
